define(["core/ajax","core/notification"],function(e,t){const a=e=>`.aulasaovivo__panel[data-panel="${e}"]`,n=".aulasaovivo__panel",o='[data-region="cards"]',s='[data-region="agenda"]',i='[data-action="refresh"]',r='[data-region="carousel"]',c='[data-region="feedback"]',l='[data-region="fallback-notice"]',d='[data-region="certificates"]',u='[data-action="switch-panel"]',m=new Map;let f=null,v={root:null,config:null,fallback:!1,formatters:{},activePanel:"catalog"};const g={catalog:null,enrolled:null,certificates:null},p={emptycatalog:"No live classes are available at the moment. Check back soon.",emptyenrolled:"You are not enrolled in any live class yet.",emptycertificates:"You do not have any certificates available yet.",enrolsuccess:"Enrolment completed successfully!",enrolfailure:"We could not complete your enrolment for this class.",integrationmissing:"Configure the class module integration to enable real enrolments.",processing:"Processing...",countdownlabel:"Starts in",countdownlive:"Live",countdownfinished:"Finished",accesssession:"Access class",enrolsession:"Enrol now",sessionclosed:"Class finished",seemore:"See details",enrolledbadge:"Enrolled",confirmedbadge:"Confirmed",toastdefault:"Update finished.",certificateissuedon:"Issued on",certificatedownload:"Download certificate",fallbacknotice:"Showing demo data. Connect the catalogue to your class module to load real sessions.",startslabel:"Date and time",endslabel:"End",locationlabel:"Location",instructorlabel:"Instructor",taglabel:"Track",agendapast:"Finished",agendalive:"Live now",agendaunconfirmed:"Upcoming"},h={},_="pt-BR",b="99";let y=[];const w=new Set,E=(setInterval(()=>{m.forEach(H)},1e3),e=>{if(!e||w.has(e))return;const a=document.getElementById(e);if(!a)return;const n=(e=>{const a=e.dataset.config;if(!a)return null;try{return JSON.parse(a)}catch(e){return t.exception(e),null}})(a),o=(e=>{const t=e&&"object"==typeof e?{...e}:{};return t.services=Object.assign({},g,t.services&&"object"==typeof t.services?t.services:{}),t.strings=Object.assign({},p,t.strings&&"object"==typeof t.strings?t.strings:{}),t.user=Object.assign({},h,t.user&&"object"==typeof t.user?t.user:{}),t.locale&&"string"==typeof t.locale||(t.locale=_),void 0!==t.timezone&&null!==t.timezone&&""!==t.timezone||(t.timezone=b),t})(n);w.add(e),v={root:a,config:o,fallback:!n,formatters:C(o),activePanel:"catalog"},y=[],N(),A(),L(),k()}),C=e=>{const t=(e=>{if(!e)return"pt-BR";const t=e.replace(/_/g,"-").split("-").filter(Boolean);if(0===t.length)return"pt-BR";const[a,n,...o]=t,s=[a.toLowerCase()];return n&&s.push(n.toUpperCase()),o.length&&s.push(...o),s.join("-")})(e.locale),a=e.timezone&&"99"!==e.timezone?e.timezone:void 0;return{date:new Intl.DateTimeFormat(t,{day:"2-digit",month:"2-digit",year:"numeric",timeZone:a}),shortDate:new Intl.DateTimeFormat(t,{day:"2-digit",month:"2-digit",timeZone:a}),time:new Intl.DateTimeFormat(t,{hour:"2-digit",minute:"2-digit",timeZone:a})}},N=()=>{v.root.querySelectorAll(r).forEach(e=>{const t=e.querySelector(o);if(!t)return;const a=e.querySelector(".aulasaovivo__nav--prev"),n=e.querySelector(".aulasaovivo__nav--next"),s=()=>{const e=Math.max(0,t.scrollWidth-t.clientWidth),o=e>4,s=Math.max(0,Math.min(t.scrollLeft,e));a&&(a.hidden=!o||s<=4),n&&(n.hidden=!o||s>=e-4)},i=e=>{const a=(e=>{if(!e)return 0;const t=e.querySelector(".aulasaovivo__card");if(!t)return e.clientWidth;const a=window.getComputedStyle(e),n=parseFloat(a.columnGap||a.gap||"0")||0;return t.getBoundingClientRect().width+n})(t);if(!a)return;const n=Math.max(0,t.scrollWidth-t.clientWidth);if(n<=0)return;const o=Math.round(t.scrollLeft/a),s=Math.ceil(n/a),i=Math.max(0,Math.min(o+e,s))*a;t.scrollTo({left:i,behavior:"smooth"})};a&&a.addEventListener("click",()=>i(-1)),n&&n.addEventListener("click",()=>i(1)),t.addEventListener("scroll",()=>window.requestAnimationFrame(s)),window.addEventListener("resize",()=>window.requestAnimationFrame(s)),e._aulasaovivoUpdateNav=s,e._aulasaovivoScrollToStart=()=>{t.scrollTo({left:0,behavior:"auto"}),s()},s()})},S=(e,t={})=>{if(!e)return;const a=$(e);if(!a)return;const{focus:o=!1,force:s=!1,refresh:i=!1}=t;if(v.activePanel!==e||s)y.forEach(t=>{const a=t.dataset.target===e;t.setAttribute("aria-selected",a?"true":"false"),t.setAttribute("tabindex",a?"0":"-1"),t.classList.toggle("is-active",a),a&&o&&t.focus()}),v.root.querySelectorAll(n).forEach(t=>{const a=t.dataset.panel===e;t.setAttribute("aria-hidden",a?"false":"true"),t.setAttribute("tabindex",a?"0":"-1"),a?(t.hidden=!1,t.removeAttribute("hidden")):t.hidden=!0}),v.activePanel=e,window.requestAnimationFrame(()=>{a.querySelectorAll(r).forEach(e=>{"function"==typeof e._aulasaovivoUpdateNav&&e._aulasaovivoUpdateNav()})}),i&&k(e);else if(o){const t=y.find(t=>t.dataset.target===e);t&&t.focus()}},A=()=>{if(y=Array.from(v.root.querySelectorAll(u)),!y.length)return;const e=y.find(e=>"true"===e.getAttribute("aria-selected")&&e.dataset.target);e&&(v.activePanel=e.dataset.target);const t=e=>{if(!y.length)return;const t=y.findIndex(e=>"true"===e.getAttribute("aria-selected")),a=((-1===t?0:t)+e+y.length)%y.length,n=y[a];n&&n.dataset.target&&S(n.dataset.target,{focus:!0})};y.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),e.dataset.target&&S(e.dataset.target,{focus:!1})}),e.addEventListener("keydown",e=>{if("ArrowRight"===e.key||"ArrowDown"===e.key)e.preventDefault(),t(1);else if("ArrowLeft"===e.key||"ArrowUp"===e.key)e.preventDefault(),t(-1);else if("Home"===e.key){e.preventDefault();const t=y[0];t&&t.dataset.target&&S(t.dataset.target,{focus:!0})}else if("End"===e.key){e.preventDefault();const t=y[y.length-1];t&&t.dataset.target&&S(t.dataset.target,{focus:!0})}})}),S(v.activePanel,{focus:!1,force:!0})},x=e=>{if(!e)return;const t=e.closest(r);t&&("function"==typeof t._aulasaovivoScrollToStart?t._aulasaovivoScrollToStart():"function"==typeof t._aulasaovivoUpdateNav&&t._aulasaovivoUpdateNav())},L=()=>{v.root.querySelectorAll(i).forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.target;e.disabled=!0,k(a).catch(t.exception).finally(()=>{window.setTimeout(()=>{e.disabled=!1},400)})})})},k=e=>{const a=e?[e]:["catalog","enrolled","certificates"];e||(v.fallback=!1),a.forEach(e=>M(e,!0));const n=a.map(e=>D(e));return Promise.allSettled(n).then(e=>{e.forEach(e=>{"rejected"===e.status&&t.exception(e.reason)})}).finally(()=>{a.forEach(e=>M(e,!1)),V()})},M=(e,t)=>{const a=$(e);a&&(t?a.setAttribute("data-loading","true"):a.removeAttribute("data-loading"))},D=t=>{let a;if("catalog"===t)a=v.config.services.catalog;else if("enrolled"===t)a=v.config.services.enrolled;else{if("certificates"!==t)return Promise.resolve();a=v.config.services.certificates}if(!a)return"certificates"===t?P([]):j(t,[]),v.fallback=!0,Promise.resolve();const[n]=e.call([{methodname:a,args:{}}]);return n.then(e=>{if("certificates"!==t&&e.usingfallback&&(v.fallback=!0),"certificates"===t){const t=q(e.certificates);P(t)}else{const a=T(e.sessions);j(t,a)}return e}).catch(e=>{throw"certificates"===t?P([]):j(t,[]),e})},T=e=>Array.isArray(e)?e:e&&"object"==typeof e?Object.values(e):[],q=e=>Array.isArray(e)?e:e&&"object"==typeof e?Object.values(e):[],$=e=>v.root.querySelector(a(e)),j=(e,t)=>{const a=$(e);if(!a)return;const n=a.querySelector(o),i=a.querySelector(s);if(!n||!i)return;I(e),n.innerHTML="",i.innerHTML="",n.scrollLeft=0;const r=t.slice().sort((e,t)=>(e.starttime||0)-(t.starttime||0));if(!r.length){const t=document.createElement("div");return t.className="aulasaovivo__empty",t.textContent="catalog"===e?v.config.strings.emptycatalog:v.config.strings.emptyenrolled,n.appendChild(t),void x(n)}r.forEach(t=>{const a=F(t,e);n.appendChild(a.element);const o=z(t);a.agendaItem=o,i.appendChild(o),B(a)}),x(n)},I=e=>{Array.from(m.entries()).forEach(([t,a])=>{a.panel===e&&m.delete(t)})},P=e=>{const t=$("certificates");if(!t)return;const a=t.querySelector(d);if(a){if(a.innerHTML="",a.scrollLeft=0,!e.length){const e=document.createElement("div");return e.className="aulasaovivo__empty",e.textContent=v.config.strings.emptycertificates,void a.appendChild(e)}e.forEach(e=>{const t=document.createElement("article");t.className="aulasaovivo__certificate-card";const n=document.createElement(e.fileurl?"a":"div");if(n.className="aulasaovivo__certificate-card-preview",e.previewurl&&n.style.setProperty("--certificate-preview",`url('${e.previewurl}')`),e.fileurl){n.href=e.fileurl,n.target="_blank",n.rel="noopener";const t=e.filename||v.config.strings.certificatedownload;n.setAttribute("aria-label",t),n.title=t}else n.classList.add("is-disabled"),n.setAttribute("aria-hidden","true");const o=document.createElement("div");o.className="aulasaovivo__certificate-card-overlay";const s=document.createElement("span");s.className="aulasaovivo__certificate-card-action",s.textContent=v.config.strings.certificatedownload,o.appendChild(s),n.appendChild(o),t.appendChild(n);const i=document.createElement("div");i.className="aulasaovivo__certificate-card-info";const r=document.createElement("h3");if(r.className="aulasaovivo__certificate-card-title",r.textContent=e.sessionname||"",i.appendChild(r),e.coursename){const t=document.createElement("div");t.className="aulasaovivo__certificate-card-course",t.textContent=e.coursename,i.appendChild(t)}const c=e.issuedatestring||(e=>{if(!e)return"";try{const t=new Date(1e3*e);return Number.isNaN(t.getTime())?"":v.formatters.date?v.formatters.date.format(t):t.toLocaleDateString()}catch(e){return""}})(e.issuedate);if(c){const e=document.createElement("div");e.className="aulasaovivo__certificate-card-meta";const t=document.createElement("span");t.className="aulasaovivo__certificate-card-date",t.textContent=`${v.config.strings.certificateissuedon} ${c}`,e.appendChild(t),i.appendChild(e)}t.appendChild(i),a.appendChild(t)})}},F=(e,t)=>{const a=document.createElement("article");a.className="aulasaovivo__card",a.dataset.panel=t,a.dataset.sessionId=e.id;const n=document.createElement("div");if(n.className="aulasaovivo__card-image",e.imageurl){const t=document.createElement("img");t.src=e.imageurl,t.alt=e.name||"",n.appendChild(t)}const o=document.createElement("div");o.className="aulasaovivo__card-overlay",n.appendChild(o);const s=document.createElement("div");s.className="aulasaovivo__card-countdown",n.appendChild(s);const i=document.createElement("div");i.className="aulasaovivo__card-info";const r=document.createElement("h3");r.className="aulasaovivo__card-title",r.textContent=e.name,i.appendChild(r);const c=document.createElement("div");if(c.className="aulasaovivo__card-meta",U(c,v.config.strings.startslabel,R(e)),U(c,v.config.strings.instructorlabel,e.instructor&&e.instructor.name,{showLabel:!1}),i.appendChild(c),Array.isArray(e.tags)&&e.tags.length){const t=document.createElement("div");t.className="aulasaovivo__card-meta",e.tags.forEach(e=>{const a=document.createElement("span");a.className="aulasaovivo__chip",a.textContent=e,t.appendChild(a)}),i.appendChild(t)}if(e.summary){const t=document.createElement("div");t.className="aulasaovivo__card-description",t.innerHTML=e.summary,i.appendChild(t)}const l=document.createElement("div");if(l.className="aulasaovivo__card-footer",e.isenrolled&&"catalog"===t){const e=document.createElement("span");e.className="aulasaovivo__badge",e.textContent=v.config.strings.enrolledbadge,l.appendChild(e)}if("enrolled"===t){const e=document.createElement("span");e.className="aulasaovivo__badge",e.textContent=v.config.strings.confirmedbadge,l.appendChild(e)}const d=document.createElement("button");d.type="button",d.className="aulasaovivo__button",l.appendChild(d),i.appendChild(l),a.appendChild(n),a.appendChild(i);const u={session:e,panel:t,element:a,button:d,countdown:s,agendaItem:null,state:"upcoming"};return d.addEventListener("click",()=>J(u)),u},U=(e,t,a,n={})=>{if(!a)return;const o=document.createElement("span");o.className="aulasaovivo__card-meta-item";const s=n.showLabel??!0;o.textContent=s&&t?`${t}: ${a}`:a,e.appendChild(o)},z=e=>{const t=document.createElement("div");t.className="aulasaovivo__agenda-item";const a=document.createElement("div");a.className="aulasaovivo__agenda-time",a.textContent=Z(e);const n=document.createElement("div");n.className="aulasaovivo__agenda-name",n.textContent=e.name;const o=document.createElement("div");return o.className="aulasaovivo__agenda-status",t.appendChild(a),t.appendChild(n),t.appendChild(o),t},B=e=>{H(e),m.set(e.element,e)},H=e=>{const t=Date.now(),a=1e3*(e.session.starttime||0),n=1e3*(e.session.duration||0),o=a&&n?a+n:a+36e5,s=e.session.endtime?1e3*e.session.endtime:o;let i=v.config.strings.agendaunconfirmed,r="past";if(!a||t<a){r="upcoming",i=v.config.strings.agendaunconfirmed;const n=(a||t)-t;e.countdown.innerHTML=`<span class="aulasaovivo__card-countdown-label">${v.config.strings.countdownlabel}</span>${O(n)}`}else if(t>=a&&t<=s){r="live",i=v.config.strings.agendalive;const a=Math.max(0,s-t);e.countdown.innerHTML=`<span class="aulasaovivo__card-countdown-label">${v.config.strings.countdownlive}</span>${O(a)}`}else r="past",i=v.config.strings.agendapast,e.countdown.innerHTML=`<span class="aulasaovivo__card-countdown-label">${v.config.strings.countdownfinished}</span>${W(a)}`;if(e.state=r,e.element.dataset.state=r,e.agendaItem){e.agendaItem.dataset.state=r;const t=e.agendaItem.querySelector(".aulasaovivo__agenda-status");t&&(t.textContent=i)}Y(e)},O=e=>{let t=Math.max(0,Math.floor(e/1e3));const a=Math.floor(t/86400);t-=86400*a;const n=Math.floor(t/3600);t-=3600*n;const o=Math.floor(t/60),s=[];return a&&s.push(`${a}d`),(n||a)&&s.push(`${n.toString().padStart(2,"0")}h`),s.push(`${o.toString().padStart(2,"0")}m`),s.join(" ")},W=e=>{if(!e)return"";const t=new Date(e);return v.formatters.shortDate.format(t)},R=e=>{if(!e.starttime)return"";const t=new Date(1e3*e.starttime);return`${v.formatters.date.format(t)} • ${v.formatters.time.format(t)}`},Z=e=>{if(!e.starttime)return"";const t=new Date(1e3*e.starttime);return`${v.formatters.shortDate.format(t)} • ${v.formatters.time.format(t)}`},Y=e=>{if(!e.button)return;const t=e.session,a=e.state,n=v.config.strings;if("catalog"!==e.panel)if("live"===a){const a=Boolean(t.launchurl);G(e,n.accesssession,a?"success":"secondary",!a)}else G(e,"upcoming"===a?n.accesssession:n.seemore,"secondary",!0);else{if(!t.isenrolled)return void("past"===a?G(e,n.sessionclosed,"secondary",!0):G(e,n.enrolsession,"primary",!1));if("live"===a){const a=Boolean(t.launchurl);G(e,n.accesssession,a?"success":"secondary",!a)}else G(e,"past"===a?n.sessionclosed:n.enrolledbadge,"secondary",!0)}},G=(e,t,a,n)=>{e.button.textContent=t,e.button.dataset.variant=a,e.button.disabled=n,e.button.setAttribute("aria-disabled",n?"true":"false")},J=e=>{if(e.button&&!e.button.disabled)if("catalog"===e.panel){if(!e.session.isenrolled&&"past"!==e.state)return void Q(e);e.session.isenrolled&&e.session.launchurl&&"live"===e.state&&K(e.session.launchurl)}else"enrolled"===e.panel&&e.session.launchurl&&"live"===e.state&&K(e.session.launchurl)},K=e=>{window.open(e,"_blank","noopener")},Q=a=>{const[n]=e.call([{methodname:v.config.services.enrol,args:{sessionid:a.session.id}}]);G(a,v.config.strings.processing,"secondary",!0),n.then(e=>{if(e.usingfallback&&(v.fallback=!0),e.status)return X(v.config.strings.enrolsuccess),a.session.isenrolled=!0,k();const t=e.message||v.config.strings.enrolfailure;X(t),a.session.isenrolled=!1,k("catalog")}).catch(e=>{t.exception(e),X(v.config.strings.enrolfailure),k("catalog")})},V=()=>{const e=v.root.querySelector(l);e&&(v.fallback?e.hidden=!1:e.hidden=!0)},X=e=>{const t=v.root.querySelector(c);t&&(t.textContent=e||v.config.strings.toastdefault,t.dataset.visible="true",clearTimeout(f),f=window.setTimeout(()=>{t.dataset.visible="false"},4e3))};return{init:e=>{e&&("loading"!==document.readyState?E(e):document.addEventListener("DOMContentLoaded",()=>E(e),{once:!0}))}}});