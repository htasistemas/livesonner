define(["core/ajax","core/notification","core_form/modalform"],function(e,t,a){const n=e=>`.aulasaovivo__panel[data-panel="${e}"]`,o=".aulasaovivo__panel",s='[data-region="cards"]',i='[data-region="agenda"]',r='[data-action="refresh"]',c='[data-region="carousel"]',l='[data-region="feedback"]',d='[data-region="fallback-notice"]',u='[data-region="certificates"]',f='[data-action="switch-panel"]',m='[data-action="manual-certificate"]',v=new Map;let g=null,p={root:null,config:null,fallback:!1,formatters:{},activePanel:"catalog"},h=null;const _={catalog:null,enrolled:null,certificates:null},b={emptycatalog:"No live classes are available at the moment. Check back soon.",emptyenrolled:"You are not enrolled in any live class yet.",emptycertificates:"You do not have any certificates available yet.",enrolsuccess:"Enrolment completed successfully!",enrolfailure:"We could not complete your enrolment for this class.",integrationmissing:"Configure the class module integration to enable real enrolments.",processing:"Processing...",countdownlabel:"Starts in",countdownlive:"Live",countdownfinished:"Finished",accesssession:"Access class",enrolsession:"Enrol now",sessionclosed:"Class finished",seemore:"See details",enrolledbadge:"Enrolled",confirmedbadge:"Confirmed",toastdefault:"Update finished.",certificateissuedon:"Issued on",certificatedownload:"Download certificate",manualcertificatetitle:"Issue certificate manually",manualcertificatesuccess:"Certificate issued successfully.",manualcertificateerror:"Unable to issue the certificate.",fallbacknotice:"Showing demo data. Connect the catalogue to your class module to load real sessions.",startslabel:"Date and time",endslabel:"End",locationlabel:"Location",instructorlabel:"Instructor",taglabel:"Track",agendapast:"Finished",agendalive:"Live now",agendaunconfirmed:"Upcoming"},y={},w="pt-BR",E="99",C=!1;let N=[];const S=new Set,L=(setInterval(()=>{v.forEach(Y)},1e3),e=>{if(!e||S.has(e))return;const a=document.getElementById(e);if(!a)return;const n=(e=>{const a=e.dataset.config;if(!a)return null;try{return JSON.parse(a)}catch(e){return t.exception(e),null}})(a),o=(e=>{const t=e&&"object"==typeof e?{...e}:{};return t.services=Object.assign({},_,t.services&&"object"==typeof t.services?t.services:{}),t.strings=Object.assign({},b,t.strings&&"object"==typeof t.strings?t.strings:{}),t.user=Object.assign({},y,t.user&&"object"==typeof t.user?t.user:{}),t.locale&&"string"==typeof t.locale||(t.locale=w),void 0!==t.timezone&&null!==t.timezone&&""!==t.timezone||(t.timezone=E),"boolean"!=typeof t.canmanualcertificates&&(t.canmanualcertificates=C),t})(n);S.add(e),p={root:a,config:o,fallback:!n,formatters:A(o),activePanel:"catalog"},N=[],x(),M(),T(),q(),$()}),A=e=>{const t=(e=>{if(!e)return"pt-BR";const t=e.replace(/_/g,"-").split("-").filter(Boolean);if(0===t.length)return"pt-BR";const[a,n,...o]=t,s=[a.toLowerCase()];return n&&s.push(n.toUpperCase()),o.length&&s.push(...o),s.join("-")})(e.locale),a=e.timezone&&"99"!==e.timezone?e.timezone:void 0;return{date:new Intl.DateTimeFormat(t,{day:"2-digit",month:"2-digit",year:"numeric",timeZone:a}),shortDate:new Intl.DateTimeFormat(t,{day:"2-digit",month:"2-digit",timeZone:a}),time:new Intl.DateTimeFormat(t,{hour:"2-digit",minute:"2-digit",timeZone:a})}},x=()=>{p.root.querySelectorAll(c).forEach(e=>{const t=e.querySelector(s);if(!t)return;const a=e.querySelector(".aulasaovivo__nav--prev"),n=e.querySelector(".aulasaovivo__nav--next"),o=()=>{const e=Math.max(0,t.scrollWidth-t.clientWidth),o=e>4,s=Math.max(0,Math.min(t.scrollLeft,e));a&&(a.hidden=!o||s<=4),n&&(n.hidden=!o||s>=e-4)},i=e=>{const a=(e=>{if(!e)return 0;const t=e.querySelector(".aulasaovivo__card");if(!t)return e.clientWidth;const a=window.getComputedStyle(e),n=parseFloat(a.columnGap||a.gap||"0")||0;return t.getBoundingClientRect().width+n})(t);if(!a)return;const n=Math.max(0,t.scrollWidth-t.clientWidth);if(n<=0)return;const o=Math.round(t.scrollLeft/a),s=Math.ceil(n/a),i=Math.max(0,Math.min(o+e,s))*a;t.scrollTo({left:i,behavior:"smooth"})};a&&a.addEventListener("click",()=>i(-1)),n&&n.addEventListener("click",()=>i(1)),t.addEventListener("scroll",()=>window.requestAnimationFrame(o)),window.addEventListener("resize",()=>window.requestAnimationFrame(o)),e._aulasaovivoUpdateNav=o,e._aulasaovivoScrollToStart=()=>{t.scrollTo({left:0,behavior:"auto"}),o()},o()})},k=(e,t={})=>{if(!e)return;const a=F(e);if(!a)return;const{focus:n=!1,force:s=!1,refresh:i=!1}=t;if(p.activePanel!==e||s)N.forEach(t=>{const a=t.dataset.target===e;t.setAttribute("aria-selected",a?"true":"false"),t.setAttribute("tabindex",a?"0":"-1"),t.classList.toggle("is-active",a),a&&n&&t.focus()}),p.root.querySelectorAll(o).forEach(t=>{const a=t.dataset.panel===e;t.setAttribute("aria-hidden",a?"false":"true"),t.setAttribute("tabindex",a?"0":"-1"),a?(t.hidden=!1,t.removeAttribute("hidden")):t.hidden=!0}),p.activePanel=e,window.requestAnimationFrame(()=>{a.querySelectorAll(c).forEach(e=>{"function"==typeof e._aulasaovivoUpdateNav&&e._aulasaovivoUpdateNav()})}),i&&$(e);else if(n){const t=N.find(t=>t.dataset.target===e);t&&t.focus()}},M=()=>{if(N=Array.from(p.root.querySelectorAll(f)),!N.length)return;const e=N.find(e=>"true"===e.getAttribute("aria-selected")&&e.dataset.target);e&&(p.activePanel=e.dataset.target);const t=e=>{if(!N.length)return;const t=N.findIndex(e=>"true"===e.getAttribute("aria-selected")),a=((-1===t?0:t)+e+N.length)%N.length,n=N[a];n&&n.dataset.target&&k(n.dataset.target,{focus:!0})};N.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),e.dataset.target&&k(e.dataset.target,{focus:!1})}),e.addEventListener("keydown",e=>{if("ArrowRight"===e.key||"ArrowDown"===e.key)e.preventDefault(),t(1);else if("ArrowLeft"===e.key||"ArrowUp"===e.key)e.preventDefault(),t(-1);else if("Home"===e.key){e.preventDefault();const t=N[0];t&&t.dataset.target&&k(t.dataset.target,{focus:!0})}else if("End"===e.key){e.preventDefault();const t=N[N.length-1];t&&t.dataset.target&&k(t.dataset.target,{focus:!0})}})}),k(p.activePanel,{focus:!1,force:!0})},D=e=>{if(!e)return;const t=e.closest(c);t&&("function"==typeof t._aulasaovivoScrollToStart?t._aulasaovivoScrollToStart():"function"==typeof t._aulasaovivoUpdateNav&&t._aulasaovivoUpdateNav())},q=()=>{if(!p.config.canmanualcertificates)return;const e=p.root.querySelector(m);e&&e.addEventListener("click",e=>{e.preventDefault(),p.config.canmanualcertificates&&(h&&(h.destroy(),h=null),h=new a({formClass:"local_aulasaovivo\\form\\manual_certificate",args:{},modalConfig:{title:p.config.strings.manualcertificatetitle}}),h.addEventListener("form:submitted",e=>{const t=(e&&e.detail?e.detail:{}).message||p.config.strings.manualcertificatesuccess;oe(t),$("certificates")}),h.addEventListener("hidden",()=>{h=null}),h.show().catch(e=>{h=null,t.exception(e),oe(p.config.strings.manualcertificateerror)}))})},T=()=>{p.root.querySelectorAll(r).forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.target;e.disabled=!0,$(a).catch(t.exception).finally(()=>{window.setTimeout(()=>{e.disabled=!1},400)})})})},$=e=>{const a=e?[e]:["catalog","enrolled","certificates"];e||(p.fallback=!1),a.forEach(e=>j(e,!0));const n=a.map(e=>I(e));return Promise.allSettled(n).then(e=>{e.forEach(e=>{"rejected"===e.status&&t.exception(e.reason)})}).finally(()=>{a.forEach(e=>j(e,!1)),ne()})},j=(e,t)=>{const a=F(e);a&&(t?a.setAttribute("data-loading","true"):a.removeAttribute("data-loading"))},I=t=>{let a;if("catalog"===t)a=p.config.services.catalog;else if("enrolled"===t)a=p.config.services.enrolled;else{if("certificates"!==t)return Promise.resolve();a=p.config.services.certificates}if(!a)return"certificates"===t?H([]):z(t,[]),p.fallback=!0,Promise.resolve();const[n]=e.call([{methodname:a,args:{}}]);return n.then(e=>{if("certificates"!==t&&e.usingfallback&&(p.fallback=!0),"certificates"===t){const t=U(e.certificates);H(t)}else{const a=P(e.sessions);z(t,a)}return e}).catch(e=>{throw"certificates"===t?H([]):z(t,[]),e})},P=e=>Array.isArray(e)?e:e&&"object"==typeof e?Object.values(e):[],U=e=>Array.isArray(e)?e:e&&"object"==typeof e?Object.values(e):[],F=e=>p.root.querySelector(n(e)),z=(e,t)=>{const a=F(e);if(!a)return;const n=a.querySelector(s),o=a.querySelector(i);if(!n||!o)return;B(e),n.innerHTML="",o.innerHTML="",n.scrollLeft=0;const r=t.slice().sort((e,t)=>(e.starttime||0)-(t.starttime||0));if(!r.length){const t=document.createElement("div");return t.className="aulasaovivo__empty",t.textContent="catalog"===e?p.config.strings.emptycatalog:p.config.strings.emptyenrolled,n.appendChild(t),void D(n)}r.forEach(t=>{const a=O(t,e);n.appendChild(a.element);const s=R(t);a.agendaItem=s,o.appendChild(s),Z(a)}),D(n)},B=e=>{Array.from(v.entries()).forEach(([t,a])=>{a.panel===e&&v.delete(t)})},H=e=>{const t=F("certificates");if(!t)return;const a=t.querySelector(u);if(a){if(a.innerHTML="",a.scrollLeft=0,!e.length){const e=document.createElement("div");return e.className="aulasaovivo__empty",e.textContent=p.config.strings.emptycertificates,void a.appendChild(e)}e.forEach(e=>{const t=document.createElement("article");t.className="aulasaovivo__certificate-card";const n=document.createElement(e.fileurl?"a":"div");if(n.className="aulasaovivo__certificate-card-preview",e.previewurl&&n.style.setProperty("--certificate-preview",`url('${e.previewurl}')`),e.fileurl){n.href=e.fileurl,n.target="_blank",n.rel="noopener";const t=e.filename||p.config.strings.certificatedownload;n.setAttribute("aria-label",t),n.title=t}else n.classList.add("is-disabled"),n.setAttribute("aria-hidden","true");const o=document.createElement("div");o.className="aulasaovivo__certificate-card-overlay";const s=document.createElement("span");s.className="aulasaovivo__certificate-card-action",s.textContent=p.config.strings.certificatedownload,o.appendChild(s),n.appendChild(o),t.appendChild(n);const i=document.createElement("div");i.className="aulasaovivo__certificate-card-info";const r=document.createElement("h3");if(r.className="aulasaovivo__certificate-card-title",r.textContent=e.sessionname||"",i.appendChild(r),e.coursename){const t=document.createElement("div");t.className="aulasaovivo__certificate-card-course",t.textContent=e.coursename,i.appendChild(t)}const c=e.issuedatestring||(e=>{if(!e)return"";try{const t=new Date(1e3*e);return Number.isNaN(t.getTime())?"":p.formatters.date?p.formatters.date.format(t):t.toLocaleDateString()}catch(e){return""}})(e.issuedate);if(c){const e=document.createElement("div");e.className="aulasaovivo__certificate-card-meta";const t=document.createElement("span");t.className="aulasaovivo__certificate-card-date",t.textContent=`${p.config.strings.certificateissuedon} ${c}`,e.appendChild(t),i.appendChild(e)}t.appendChild(i),a.appendChild(t)})}},O=(e,t)=>{const a=document.createElement("article");a.className="aulasaovivo__card",a.dataset.panel=t,a.dataset.sessionId=e.id;const n=document.createElement("div");if(n.className="aulasaovivo__card-image",e.imageurl){const t=document.createElement("img");t.src=e.imageurl,t.alt=e.name||"",n.appendChild(t)}const o=document.createElement("div");o.className="aulasaovivo__card-overlay",n.appendChild(o);const s=document.createElement("div");s.className="aulasaovivo__card-countdown",n.appendChild(s);const i=document.createElement("div");i.className="aulasaovivo__card-info";const r=document.createElement("h3");r.className="aulasaovivo__card-title",r.textContent=e.name,i.appendChild(r);const c=document.createElement("div");if(c.className="aulasaovivo__card-meta",W(c,p.config.strings.startslabel,K(e)),W(c,p.config.strings.instructorlabel,e.instructor&&e.instructor.name,{showLabel:!1}),i.appendChild(c),Array.isArray(e.tags)&&e.tags.length){const t=document.createElement("div");t.className="aulasaovivo__card-meta",e.tags.forEach(e=>{const a=document.createElement("span");a.className="aulasaovivo__chip",a.textContent=e,t.appendChild(a)}),i.appendChild(t)}if(e.summary){const t=document.createElement("div");t.className="aulasaovivo__card-description",t.innerHTML=e.summary,i.appendChild(t)}const l=document.createElement("div");if(l.className="aulasaovivo__card-footer",e.isenrolled&&"catalog"===t){const e=document.createElement("span");e.className="aulasaovivo__badge",e.textContent=p.config.strings.enrolledbadge,l.appendChild(e)}if("enrolled"===t){const e=document.createElement("span");e.className="aulasaovivo__badge",e.textContent=p.config.strings.confirmedbadge,l.appendChild(e)}const d=document.createElement("button");d.type="button",d.className="aulasaovivo__button",l.appendChild(d),i.appendChild(l),a.appendChild(n),a.appendChild(i);const u={session:e,panel:t,element:a,button:d,countdown:s,agendaItem:null,state:"upcoming"};return d.addEventListener("click",()=>ee(u)),u},W=(e,t,a,n={})=>{if(!a)return;const o=document.createElement("span");o.className="aulasaovivo__card-meta-item";const s=n.showLabel??!0;o.textContent=s&&t?`${t}: ${a}`:a,e.appendChild(o)},R=e=>{const t=document.createElement("div");t.className="aulasaovivo__agenda-item";const a=document.createElement("div");a.className="aulasaovivo__agenda-time",a.textContent=Q(e);const n=document.createElement("div");n.className="aulasaovivo__agenda-name",n.textContent=e.name;const o=document.createElement("div");return o.className="aulasaovivo__agenda-status",t.appendChild(a),t.appendChild(n),t.appendChild(o),t},Z=e=>{Y(e),v.set(e.element,e)},Y=e=>{const t=Date.now(),a=1e3*(e.session.starttime||0),n=1e3*(e.session.duration||0),o=a&&n?a+n:a+36e5,s=e.session.endtime?1e3*e.session.endtime:o;let i=p.config.strings.agendaunconfirmed,r="past";if(!a||t<a){r="upcoming",i=p.config.strings.agendaunconfirmed;const n=(a||t)-t;e.countdown.innerHTML=`<span class="aulasaovivo__card-countdown-label">${p.config.strings.countdownlabel}</span>${G(n)}`}else if(t>=a&&t<=s){r="live",i=p.config.strings.agendalive;const a=Math.max(0,s-t);e.countdown.innerHTML=`<span class="aulasaovivo__card-countdown-label">${p.config.strings.countdownlive}</span>${G(a)}`}else r="past",i=p.config.strings.agendapast,e.countdown.innerHTML=`<span class="aulasaovivo__card-countdown-label">${p.config.strings.countdownfinished}</span>${J(a)}`;if(e.state=r,e.element.dataset.state=r,e.agendaItem){e.agendaItem.dataset.state=r;const t=e.agendaItem.querySelector(".aulasaovivo__agenda-status");t&&(t.textContent=i)}V(e)},G=e=>{let t=Math.max(0,Math.floor(e/1e3));const a=Math.floor(t/86400);t-=86400*a;const n=Math.floor(t/3600);t-=3600*n;const o=Math.floor(t/60),s=[];return a&&s.push(`${a}d`),(n||a)&&s.push(`${n.toString().padStart(2,"0")}h`),s.push(`${o.toString().padStart(2,"0")}m`),s.join(" ")},J=e=>{if(!e)return"";const t=new Date(e);return p.formatters.shortDate.format(t)},K=e=>{if(!e.starttime)return"";const t=new Date(1e3*e.starttime);return`${p.formatters.date.format(t)} • ${p.formatters.time.format(t)}`},Q=e=>{if(!e.starttime)return"";const t=new Date(1e3*e.starttime);return`${p.formatters.shortDate.format(t)} • ${p.formatters.time.format(t)}`},V=e=>{if(!e.button)return;const t=e.session,a=e.state,n=p.config.strings;if("catalog"!==e.panel)if("live"===a){const a=Boolean(t.launchurl);X(e,n.accesssession,a?"success":"secondary",!a)}else X(e,"upcoming"===a?n.accesssession:n.seemore,"secondary",!0);else{if(!t.isenrolled)return void("past"===a?X(e,n.sessionclosed,"secondary",!0):X(e,n.enrolsession,"primary",!1));if("live"===a){const a=Boolean(t.launchurl);X(e,n.accesssession,a?"success":"secondary",!a)}else X(e,"past"===a?n.sessionclosed:n.enrolledbadge,"secondary",!0)}},X=(e,t,a,n)=>{e.button.textContent=t,e.button.dataset.variant=a,e.button.disabled=n,e.button.setAttribute("aria-disabled",n?"true":"false")},ee=e=>{if(e.button&&!e.button.disabled)if("catalog"===e.panel){if(!e.session.isenrolled&&"past"!==e.state)return void ae(e);e.session.isenrolled&&e.session.launchurl&&"live"===e.state&&te(e.session.launchurl)}else"enrolled"===e.panel&&e.session.launchurl&&"live"===e.state&&te(e.session.launchurl)},te=e=>{window.open(e,"_blank","noopener")},ae=a=>{const[n]=e.call([{methodname:p.config.services.enrol,args:{sessionid:a.session.id}}]);X(a,p.config.strings.processing,"secondary",!0),n.then(e=>{if(e.usingfallback&&(p.fallback=!0),e.status)return oe(p.config.strings.enrolsuccess),a.session.isenrolled=!0,$();const t=e.message||p.config.strings.enrolfailure;oe(t),a.session.isenrolled=!1,$("catalog")}).catch(e=>{t.exception(e),oe(p.config.strings.enrolfailure),$("catalog")})},ne=()=>{const e=p.root.querySelector(d);e&&(p.fallback?e.hidden=!1:e.hidden=!0)},oe=e=>{const t=p.root.querySelector(l);t&&(t.textContent=e||p.config.strings.toastdefault,t.dataset.visible="true",clearTimeout(g),g=window.setTimeout(()=>{t.dataset.visible="false"},4e3))};return{init:e=>{e&&("loading"!==document.readyState?L(e):document.addEventListener("DOMContentLoaded",()=>L(e),{once:!0}))}}});