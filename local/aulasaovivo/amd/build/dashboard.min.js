define(["core/ajax","core/notification","core_form/modalform","core/modal_events"],function(e,t,a,n){const o=e=>`.aulasaovivo__panel[data-panel="${e}"]`,s=".aulasaovivo__panel",i='[data-region="cards"]',r='[data-region="agenda"]',c='[data-action="refresh"]',l='[data-region="carousel"]',d='[data-region="feedback"]',u='[data-region="fallback-notice"]',f='[data-region="certificates"]',m='[data-action="switch-panel"]',v='[data-action="manual-certificate"]',g=new Map;let p=null,h={root:null,config:null,fallback:!1,formatters:{},activePanel:"catalog"},_=null;const b={catalog:null,enrolled:null,certificates:null},y={emptycatalog:"No live classes are available at the moment. Check back soon.",emptyenrolled:"You are not enrolled in any live class yet.",emptycertificates:"You do not have any certificates available yet.",enrolsuccess:"Enrolment completed successfully!",enrolfailure:"We could not complete your enrolment for this class.",integrationmissing:"Configure the class module integration to enable real enrolments.",processing:"Processing...",countdownlabel:"Starts in",countdownlive:"Live",countdownfinished:"Finished",accesssession:"Access class",enrolsession:"Enrol now",sessionclosed:"Class finished",seemore:"See details",enrolledbadge:"Enrolled",confirmedbadge:"Confirmed",toastdefault:"Update finished.",certificateissuedon:"Issued on",certificatedownload:"Download certificate",manualcertificatetitle:"Issue certificate manually",manualcertificatesuccess:"Certificate issued successfully.",manualcertificateerror:"Unable to issue the certificate.",fallbacknotice:"Showing demo data. Connect the catalogue to your class module to load real sessions.",startslabel:"Date and time",endslabel:"End",locationlabel:"Location",instructorlabel:"Instructor",taglabel:"Track",agendapast:"Finished",agendalive:"Live now",agendaunconfirmed:"Upcoming"},w={},E="pt-BR",C="99",N=!1;let S=[];const L=new Set,A=(setInterval(()=>{g.forEach(G)},1e3),e=>{if(!e||L.has(e))return;const a=document.getElementById(e);if(!a)return;const n=(e=>{const a=e.dataset.config;if(!a)return null;try{return JSON.parse(a)}catch(e){return t.exception(e),null}})(a),o=(e=>{const t=e&&"object"==typeof e?{...e}:{};return t.services=Object.assign({},b,t.services&&"object"==typeof t.services?t.services:{}),t.strings=Object.assign({},y,t.strings&&"object"==typeof t.strings?t.strings:{}),t.user=Object.assign({},w,t.user&&"object"==typeof t.user?t.user:{}),t.locale&&"string"==typeof t.locale||(t.locale=E),void 0!==t.timezone&&null!==t.timezone&&""!==t.timezone||(t.timezone=C),"boolean"!=typeof t.canmanualcertificates&&(t.canmanualcertificates=N),t})(n);L.add(e),h={root:a,config:o,fallback:!n,formatters:x(o),activePanel:"catalog"},S=[],k(),D(),$(),q(),I()}),x=e=>{const t=(e=>{if(!e)return"pt-BR";const t=e.replace(/_/g,"-").split("-").filter(Boolean);if(0===t.length)return"pt-BR";const[a,n,...o]=t,s=[a.toLowerCase()];return n&&s.push(n.toUpperCase()),o.length&&s.push(...o),s.join("-")})(e.locale),a=e.timezone&&"99"!==e.timezone?e.timezone:void 0;return{date:new Intl.DateTimeFormat(t,{day:"2-digit",month:"2-digit",year:"numeric",timeZone:a}),shortDate:new Intl.DateTimeFormat(t,{day:"2-digit",month:"2-digit",timeZone:a}),time:new Intl.DateTimeFormat(t,{hour:"2-digit",minute:"2-digit",timeZone:a})}},k=()=>{h.root.querySelectorAll(l).forEach(e=>{const t=e.querySelector(i);if(!t)return;const a=e.querySelector(".aulasaovivo__nav--prev"),n=e.querySelector(".aulasaovivo__nav--next"),o=()=>{const e=Math.max(0,t.scrollWidth-t.clientWidth),o=e>4,s=Math.max(0,Math.min(t.scrollLeft,e));a&&(a.hidden=!o||s<=4),n&&(n.hidden=!o||s>=e-4)},s=e=>{const a=(e=>{if(!e)return 0;const t=e.querySelector(".aulasaovivo__card");if(!t)return e.clientWidth;const a=window.getComputedStyle(e),n=parseFloat(a.columnGap||a.gap||"0")||0;return t.getBoundingClientRect().width+n})(t);if(!a)return;const n=Math.max(0,t.scrollWidth-t.clientWidth);if(n<=0)return;const o=Math.round(t.scrollLeft/a),s=Math.ceil(n/a),i=Math.max(0,Math.min(o+e,s))*a;t.scrollTo({left:i,behavior:"smooth"})};a&&a.addEventListener("click",()=>s(-1)),n&&n.addEventListener("click",()=>s(1)),t.addEventListener("scroll",()=>window.requestAnimationFrame(o)),window.addEventListener("resize",()=>window.requestAnimationFrame(o)),e._aulasaovivoUpdateNav=o,e._aulasaovivoScrollToStart=()=>{t.scrollTo({left:0,behavior:"auto"}),o()},o()})},M=(e,t={})=>{if(!e)return;const a=B(e);if(!a)return;const{focus:n=!1,force:o=!1,refresh:i=!1}=t;if(h.activePanel!==e||o)S.forEach(t=>{const a=t.dataset.target===e;t.setAttribute("aria-selected",a?"true":"false"),t.setAttribute("tabindex",a?"0":"-1"),t.classList.toggle("is-active",a),a&&n&&t.focus()}),h.root.querySelectorAll(s).forEach(t=>{const a=t.dataset.panel===e;t.setAttribute("aria-hidden",a?"false":"true"),t.setAttribute("tabindex",a?"0":"-1"),a?(t.hidden=!1,t.removeAttribute("hidden")):t.hidden=!0}),h.activePanel=e,window.requestAnimationFrame(()=>{a.querySelectorAll(l).forEach(e=>{"function"==typeof e._aulasaovivoUpdateNav&&e._aulasaovivoUpdateNav()})}),i&&I(e);else if(n){const t=S.find(t=>t.dataset.target===e);t&&t.focus()}},D=()=>{if(S=Array.from(h.root.querySelectorAll(m)),!S.length)return;const e=S.find(e=>"true"===e.getAttribute("aria-selected")&&e.dataset.target);e&&(h.activePanel=e.dataset.target);const t=e=>{if(!S.length)return;const t=S.findIndex(e=>"true"===e.getAttribute("aria-selected")),a=((-1===t?0:t)+e+S.length)%S.length,n=S[a];n&&n.dataset.target&&M(n.dataset.target,{focus:!0})};S.forEach(e=>{e.addEventListener("click",t=>{t.preventDefault(),e.dataset.target&&M(e.dataset.target,{focus:!1})}),e.addEventListener("keydown",e=>{if("ArrowRight"===e.key||"ArrowDown"===e.key)e.preventDefault(),t(1);else if("ArrowLeft"===e.key||"ArrowUp"===e.key)e.preventDefault(),t(-1);else if("Home"===e.key){e.preventDefault();const t=S[0];t&&t.dataset.target&&M(t.dataset.target,{focus:!0})}else if("End"===e.key){e.preventDefault();const t=S[S.length-1];t&&t.dataset.target&&M(t.dataset.target,{focus:!0})}})}),M(h.activePanel,{focus:!1,force:!0})},T=e=>{if(!e)return;const t=e.closest(l);t&&("function"==typeof t._aulasaovivoScrollToStart?t._aulasaovivoScrollToStart():"function"==typeof t._aulasaovivoUpdateNav&&t._aulasaovivoUpdateNav())},q=()=>{if(!h.config.canmanualcertificates)return;const e=h.root.querySelector(v);e&&e.addEventListener("click",e=>{e.preventDefault(),h.config.canmanualcertificates&&(_||(_=new a({formClass:"local_aulasaovivo\\form\\manual_certificate",args:{},modalConfig:{title:h.config.strings.manualcertificatetitle}}),_.addEventListener(_.events.FORM_SUBMITTED,e=>{const t=(e&&e.detail?e.detail:{}).message||h.config.strings.manualcertificatesuccess;se(t),I("certificates")}),_.addEventListener(n.destroyed,()=>{_=null})),_.show().catch(e=>{_=null,t.exception(e),se(h.config.strings.manualcertificateerror)}))})},$=()=>{h.root.querySelectorAll(c).forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.target;e.disabled=!0,I(a).catch(t.exception).finally(()=>{window.setTimeout(()=>{e.disabled=!1},400)})})})},I=e=>{const a=e?[e]:["catalog","enrolled","certificates"];e||(h.fallback=!1),a.forEach(e=>j(e,!0));const n=a.map(e=>P(e));return Promise.allSettled(n).then(e=>{e.forEach(e=>{"rejected"===e.status&&t.exception(e.reason)})}).finally(()=>{a.forEach(e=>j(e,!1)),oe()})},j=(e,t)=>{const a=B(e);a&&(t?a.setAttribute("data-loading","true"):a.removeAttribute("data-loading"))},P=t=>{let a;if("catalog"===t)a=h.config.services.catalog;else if("enrolled"===t)a=h.config.services.enrolled;else{if("certificates"!==t)return Promise.resolve();a=h.config.services.certificates}if(!a)return"certificates"===t?O([]):z(t,[]),h.fallback=!0,Promise.resolve();const[n]=e.call([{methodname:a,args:{}}]);return n.then(e=>{if("certificates"!==t&&e.usingfallback&&(h.fallback=!0),"certificates"===t){const t=F(e.certificates);O(t)}else{const a=U(e.sessions);z(t,a)}return e}).catch(e=>{throw"certificates"===t?O([]):z(t,[]),e})},U=e=>Array.isArray(e)?e:e&&"object"==typeof e?Object.values(e):[],F=e=>Array.isArray(e)?e:e&&"object"==typeof e?Object.values(e):[],B=e=>h.root.querySelector(o(e)),z=(e,t)=>{const a=B(e);if(!a)return;const n=a.querySelector(i),o=a.querySelector(r);if(!n||!o)return;H(e),n.innerHTML="",o.innerHTML="",n.scrollLeft=0;const s=t.slice().sort((e,t)=>(e.starttime||0)-(t.starttime||0));if(!s.length){const t=document.createElement("div");return t.className="aulasaovivo__empty",t.textContent="catalog"===e?h.config.strings.emptycatalog:h.config.strings.emptyenrolled,n.appendChild(t),void T(n)}s.forEach(t=>{const a=R(t,e);n.appendChild(a.element);const s=Z(t);a.agendaItem=s,o.appendChild(s),Y(a)}),T(n)},H=e=>{Array.from(g.entries()).forEach(([t,a])=>{a.panel===e&&g.delete(t)})},O=e=>{const t=B("certificates");if(!t)return;const a=t.querySelector(f);if(a){if(a.innerHTML="",a.scrollLeft=0,!e.length){const e=document.createElement("div");return e.className="aulasaovivo__empty",e.textContent=h.config.strings.emptycertificates,void a.appendChild(e)}e.forEach(e=>{const t=document.createElement("article");t.className="aulasaovivo__certificate-card";const n=document.createElement(e.fileurl?"a":"div");if(n.className="aulasaovivo__certificate-card-preview",e.previewurl&&n.style.setProperty("--certificate-preview",`url('${e.previewurl}')`),e.fileurl){n.href=e.fileurl,n.target="_blank",n.rel="noopener";const t=e.filename||h.config.strings.certificatedownload;n.setAttribute("aria-label",t),n.title=t}else n.classList.add("is-disabled"),n.setAttribute("aria-hidden","true");const o=document.createElement("div");o.className="aulasaovivo__certificate-card-overlay";const s=document.createElement("span");s.className="aulasaovivo__certificate-card-action",s.textContent=h.config.strings.certificatedownload,o.appendChild(s),n.appendChild(o),t.appendChild(n);const i=document.createElement("div");i.className="aulasaovivo__certificate-card-info";const r=document.createElement("h3");if(r.className="aulasaovivo__certificate-card-title",r.textContent=e.sessionname||"",i.appendChild(r),e.coursename){const t=document.createElement("div");t.className="aulasaovivo__certificate-card-course",t.textContent=e.coursename,i.appendChild(t)}const c=e.issuedatestring||(e=>{if(!e)return"";try{const t=new Date(1e3*e);return Number.isNaN(t.getTime())?"":h.formatters.date?h.formatters.date.format(t):t.toLocaleDateString()}catch(e){return""}})(e.issuedate);if(c){const e=document.createElement("div");e.className="aulasaovivo__certificate-card-meta";const t=document.createElement("span");t.className="aulasaovivo__certificate-card-date",t.textContent=`${h.config.strings.certificateissuedon} ${c}`,e.appendChild(t),i.appendChild(e)}t.appendChild(i),a.appendChild(t)})}},R=(e,t)=>{const a=document.createElement("article");a.className="aulasaovivo__card",a.dataset.panel=t,a.dataset.sessionId=e.id;const n=document.createElement("div");if(n.className="aulasaovivo__card-image",e.imageurl){const t=document.createElement("img");t.src=e.imageurl,t.alt=e.name||"",n.appendChild(t)}const o=document.createElement("div");o.className="aulasaovivo__card-overlay",n.appendChild(o);const s=document.createElement("div");s.className="aulasaovivo__card-countdown",n.appendChild(s);const i=document.createElement("div");i.className="aulasaovivo__card-info";const r=document.createElement("h3");r.className="aulasaovivo__card-title",r.textContent=e.name,i.appendChild(r);const c=document.createElement("div");if(c.className="aulasaovivo__card-meta",W(c,h.config.strings.startslabel,Q(e)),W(c,h.config.strings.instructorlabel,e.instructor&&e.instructor.name,{showLabel:!1}),i.appendChild(c),Array.isArray(e.tags)&&e.tags.length){const t=document.createElement("div");t.className="aulasaovivo__card-meta",e.tags.forEach(e=>{const a=document.createElement("span");a.className="aulasaovivo__chip",a.textContent=e,t.appendChild(a)}),i.appendChild(t)}if(e.summary){const t=document.createElement("div");t.className="aulasaovivo__card-description",t.innerHTML=e.summary,i.appendChild(t)}const l=document.createElement("div");if(l.className="aulasaovivo__card-footer",e.isenrolled&&"catalog"===t){const e=document.createElement("span");e.className="aulasaovivo__badge",e.textContent=h.config.strings.enrolledbadge,l.appendChild(e)}if("enrolled"===t){const e=document.createElement("span");e.className="aulasaovivo__badge",e.textContent=h.config.strings.confirmedbadge,l.appendChild(e)}const d=document.createElement("button");d.type="button",d.className="aulasaovivo__button",l.appendChild(d),i.appendChild(l),a.appendChild(n),a.appendChild(i);const u={session:e,panel:t,element:a,button:d,countdown:s,agendaItem:null,state:"upcoming"};return d.addEventListener("click",()=>te(u)),u},W=(e,t,a,n={})=>{if(!a)return;const o=document.createElement("span");o.className="aulasaovivo__card-meta-item";const s=n.showLabel??!0;o.textContent=s&&t?`${t}: ${a}`:a,e.appendChild(o)},Z=e=>{const t=document.createElement("div");t.className="aulasaovivo__agenda-item";const a=document.createElement("div");a.className="aulasaovivo__agenda-time",a.textContent=V(e);const n=document.createElement("div");n.className="aulasaovivo__agenda-name",n.textContent=e.name;const o=document.createElement("div");return o.className="aulasaovivo__agenda-status",t.appendChild(a),t.appendChild(n),t.appendChild(o),t},Y=e=>{G(e),g.set(e.element,e)},G=e=>{const t=Date.now(),a=1e3*(e.session.starttime||0),n=1e3*(e.session.duration||0),o=a&&n?a+n:a+36e5,s=e.session.endtime?1e3*e.session.endtime:o;let i=h.config.strings.agendaunconfirmed,r="past";if(!a||t<a){r="upcoming",i=h.config.strings.agendaunconfirmed;const n=(a||t)-t;e.countdown.innerHTML=`<span class="aulasaovivo__card-countdown-label">${h.config.strings.countdownlabel}</span>${J(n)}`}else if(t>=a&&t<=s){r="live",i=h.config.strings.agendalive;const a=Math.max(0,s-t);e.countdown.innerHTML=`<span class="aulasaovivo__card-countdown-label">${h.config.strings.countdownlive}</span>${J(a)}`}else r="past",i=h.config.strings.agendapast,e.countdown.innerHTML=`<span class="aulasaovivo__card-countdown-label">${h.config.strings.countdownfinished}</span>${K(a)}`;if(e.state=r,e.element.dataset.state=r,e.agendaItem){e.agendaItem.dataset.state=r;const t=e.agendaItem.querySelector(".aulasaovivo__agenda-status");t&&(t.textContent=i)}X(e)},J=e=>{let t=Math.max(0,Math.floor(e/1e3));const a=Math.floor(t/86400);t-=86400*a;const n=Math.floor(t/3600);t-=3600*n;const o=Math.floor(t/60),s=[];return a&&s.push(`${a}d`),(n||a)&&s.push(`${n.toString().padStart(2,"0")}h`),s.push(`${o.toString().padStart(2,"0")}m`),s.join(" ")},K=e=>{if(!e)return"";const t=new Date(e);return h.formatters.shortDate.format(t)},Q=e=>{if(!e.starttime)return"";const t=new Date(1e3*e.starttime);return`${h.formatters.date.format(t)} • ${h.formatters.time.format(t)}`},V=e=>{if(!e.starttime)return"";const t=new Date(1e3*e.starttime);return`${h.formatters.shortDate.format(t)} • ${h.formatters.time.format(t)}`},X=e=>{if(!e.button)return;const t=e.session,a=e.state,n=h.config.strings;if("catalog"!==e.panel)if("live"===a){const a=Boolean(t.launchurl);ee(e,n.accesssession,a?"success":"secondary",!a)}else ee(e,"upcoming"===a?n.accesssession:n.seemore,"secondary",!0);else{if(!t.isenrolled)return void("past"===a?ee(e,n.sessionclosed,"secondary",!0):ee(e,n.enrolsession,"primary",!1));if("live"===a){const a=Boolean(t.launchurl);ee(e,n.accesssession,a?"success":"secondary",!a)}else ee(e,"past"===a?n.sessionclosed:n.enrolledbadge,"secondary",!0)}},ee=(e,t,a,n)=>{e.button.textContent=t,e.button.dataset.variant=a,e.button.disabled=n,e.button.setAttribute("aria-disabled",n?"true":"false")},te=e=>{if(e.button&&!e.button.disabled)if("catalog"===e.panel){if(!e.session.isenrolled&&"past"!==e.state)return void ne(e);e.session.isenrolled&&e.session.launchurl&&"live"===e.state&&ae(e.session.launchurl)}else"enrolled"===e.panel&&e.session.launchurl&&"live"===e.state&&ae(e.session.launchurl)},ae=e=>{window.open(e,"_blank","noopener")},ne=a=>{const[n]=e.call([{methodname:h.config.services.enrol,args:{sessionid:a.session.id}}]);ee(a,h.config.strings.processing,"secondary",!0),n.then(e=>{if(e.usingfallback&&(h.fallback=!0),e.status)return se(h.config.strings.enrolsuccess),a.session.isenrolled=!0,I();const t=e.message||h.config.strings.enrolfailure;se(t),a.session.isenrolled=!1,I("catalog")}).catch(e=>{t.exception(e),se(h.config.strings.enrolfailure),I("catalog")})},oe=()=>{const e=h.root.querySelector(u);e&&(h.fallback?e.hidden=!1:e.hidden=!0)},se=e=>{const t=h.root.querySelector(d);t&&(t.textContent=e||h.config.strings.toastdefault,t.dataset.visible="true",clearTimeout(p),p=window.setTimeout(()=>{t.dataset.visible="false"},4e3))};return{init:e=>{e&&("loading"!==document.readyState?A(e):document.addEventListener("DOMContentLoaded",()=>A(e),{once:!0}))}}});