define(["core/ajax","core/notification"],function(e,t){const a=e=>`.aulasaovivo__panel[data-panel="${e}"]`,n='[data-region="cards"]',o='[data-region="agenda"]',s='[data-action="refresh"]',i='[data-region="carousel"]',r='[data-region="feedback"]',c='[data-region="fallback-notice"]',l='[data-region="certificates"]',d=new Map;let u=null,m={root:null,config:null,fallback:!1,formatters:{}};setInterval(()=>{d.forEach($)},1e3);const f=e=>{const t=(e=>{if(!e)return"pt-BR";const t=e.replace(/_/g,"-").split("-").filter(Boolean);if(0===t.length)return"pt-BR";const[a,n,...o]=t,s=[a.toLowerCase()];return n&&s.push(n.toUpperCase()),o.length&&s.push(...o),s.join("-")})(e.locale),a=e.timezone&&"99"!==e.timezone?e.timezone:void 0;return{date:new Intl.DateTimeFormat(t,{day:"2-digit",month:"2-digit",year:"numeric",timeZone:a}),shortDate:new Intl.DateTimeFormat(t,{day:"2-digit",month:"2-digit",timeZone:a}),time:new Intl.DateTimeFormat(t,{hour:"2-digit",minute:"2-digit",timeZone:a})}},v=()=>{m.root.querySelectorAll(i).forEach(e=>{const t=e.querySelector(n);if(!t)return;const a=e.querySelector(".aulasaovivo__nav--prev"),o=e.querySelector(".aulasaovivo__nav--next"),s=()=>{const e=Math.max(0,t.scrollWidth-t.clientWidth),n=e>4,s=Math.max(0,Math.min(t.scrollLeft,e));a&&(a.hidden=!n||s<=4),o&&(o.hidden=!n||s>=e-4)},i=e=>{const a=(e=>{if(!e)return 0;const t=e.querySelector(".aulasaovivo__card");if(!t)return e.clientWidth;const a=window.getComputedStyle(e),n=parseFloat(a.columnGap||a.gap||"0")||0;return t.getBoundingClientRect().width+n})(t);if(!a)return;const n=Math.max(0,t.scrollWidth-t.clientWidth);if(n<=0)return;const o=Math.round(t.scrollLeft/a),s=Math.ceil(n/a),i=Math.max(0,Math.min(o+e,s))*a;t.scrollTo({left:i,behavior:"smooth"})};a&&a.addEventListener("click",()=>i(-1)),o&&o.addEventListener("click",()=>i(1)),t.addEventListener("scroll",()=>window.requestAnimationFrame(s)),window.addEventListener("resize",()=>window.requestAnimationFrame(s)),e._aulasaovivoUpdateNav=s,e._aulasaovivoScrollToStart=()=>{t.scrollTo({left:0,behavior:"auto"}),s()},s()})},g=e=>{if(!e)return;const t=e.closest(i);t&&("function"==typeof t._aulasaovivoScrollToStart?t._aulasaovivoScrollToStart():"function"==typeof t._aulasaovivoUpdateNav&&t._aulasaovivoUpdateNav())},p=()=>{m.root.querySelectorAll(s).forEach(e=>{e.addEventListener("click",()=>{const a=e.dataset.target;e.disabled=!0,h(a).catch(t.exception).finally(()=>{window.setTimeout(()=>{e.disabled=!1},400)})})})},h=e=>{const a=e?[e]:["catalog","enrolled","certificates"];e||(m.fallback=!1),a.forEach(e=>_(e,!0));const n=a.map(e=>b(e));return Promise.allSettled(n).then(e=>{e.forEach(e=>{"rejected"===e.status&&t.exception(e.reason)})}).finally(()=>{a.forEach(e=>_(e,!1)),W()})},_=(e,t)=>{const a=E(e);a&&(t?a.setAttribute("data-loading","true"):a.removeAttribute("data-loading"))},b=t=>{let a;if("catalog"===t)a=m.config.services.catalog;else if("enrolled"===t)a=m.config.services.enrolled;else{if("certificates"!==t)return Promise.resolve();a=m.config.services.certificates}const[n]=e.call([{methodname:a,args:{}}]);return n.then(e=>{if("certificates"!==t&&e.usingfallback&&(m.fallback=!0),"certificates"===t){const t=C(e.certificates);x(t)}else{const a=y(e.sessions);w(t,a)}return e}).catch(e=>{throw"certificates"===t?x([]):w(t,[]),e})},y=e=>Array.isArray(e)?e:e&&"object"==typeof e?Object.values(e):[],C=e=>Array.isArray(e)?e:e&&"object"==typeof e?Object.values(e):[],E=e=>m.root.querySelector(a(e)),w=(e,t)=>{const a=E(e);if(!a)return;const s=a.querySelector(n),i=a.querySelector(o);if(!s||!i)return;N(e),s.innerHTML="",i.innerHTML="",s.scrollLeft=0;const r=t.slice().sort((e,t)=>(e.starttime||0)-(t.starttime||0));if(!r.length){const t=document.createElement("div");return t.className="aulasaovivo__empty",t.textContent="catalog"===e?m.config.strings.emptycatalog:m.config.strings.emptyenrolled,s.appendChild(t),void g(s)}r.forEach(t=>{const a=S(t,e);s.appendChild(a.element);const n=L(t);a.agendaItem=n,i.appendChild(n),T(a)}),g(s)},N=e=>{Array.from(d.entries()).forEach(([t,a])=>{a.panel===e&&d.delete(t)})},x=e=>{const t=E("certificates");if(!t)return;const a=t.querySelector(l);if(a){if(a.innerHTML="",!e.length){const e=document.createElement("div");return e.className="aulasaovivo__empty",e.textContent=m.config.strings.emptycertificates,void a.appendChild(e)}e.forEach(e=>{const t=document.createElement("article");t.className="aulasaovivo__certificate";const n=document.createElement("h3");if(n.className="aulasaovivo__certificate-title",n.textContent=e.sessionname||"",t.appendChild(n),e.coursename){const a=document.createElement("div");a.className="aulasaovivo__certificate-course",a.textContent=e.coursename,t.appendChild(a)}const o=document.createElement("div");o.className="aulasaovivo__certificate-date";const s=e.issuedatestring||(e=>{if(!e)return"";try{const t=new Date(1e3*e);return Number.isNaN(t.getTime())?"":m.formatters.date?m.formatters.date.format(t):t.toLocaleDateString()}catch(e){return""}})(e.issuedate);if(o.textContent=s?`${m.config.strings.certificateissuedon} ${s}`:m.config.strings.certificateissuedon,t.appendChild(o),e.fileurl){const a=document.createElement("div");a.className="aulasaovivo__certificate-actions";const n=document.createElement("a");n.href=e.fileurl,n.target="_blank",n.rel="noopener noreferrer",n.classList.add("aulasaovivo__button"),n.setAttribute("data-variant","primary"),n.textContent=m.config.strings.certificatedownload,a.appendChild(n),t.appendChild(a)}a.appendChild(t)})}},S=(e,t)=>{const a=document.createElement("article");a.className="aulasaovivo__card",a.dataset.panel=t,a.dataset.sessionId=e.id;const n=document.createElement("div");if(n.className="aulasaovivo__card-image",e.imageurl){const t=document.createElement("img");t.src=e.imageurl,t.alt=e.name||"",n.appendChild(t)}const o=document.createElement("div");o.className="aulasaovivo__card-overlay",n.appendChild(o);const s=document.createElement("div");s.className="aulasaovivo__card-countdown",n.appendChild(s);const i=document.createElement("div");i.className="aulasaovivo__card-info";const r=document.createElement("h3");r.className="aulasaovivo__card-title",r.textContent=e.name,i.appendChild(r);const c=document.createElement("div");if(c.className="aulasaovivo__card-meta",M(c,m.config.strings.startslabel,A(e)),M(c,m.config.strings.instructorlabel,e.instructor&&e.instructor.name,{showLabel:!1}),i.appendChild(c),Array.isArray(e.tags)&&e.tags.length){const t=document.createElement("div");t.className="aulasaovivo__card-meta",e.tags.forEach(e=>{const a=document.createElement("span");a.className="aulasaovivo__chip",a.textContent=e,t.appendChild(a)}),i.appendChild(t)}if(e.summary){const t=document.createElement("div");t.className="aulasaovivo__card-description",t.innerHTML=e.summary,i.appendChild(t)}const l=document.createElement("div");if(l.className="aulasaovivo__card-footer",e.isenrolled&&"catalog"===t){const e=document.createElement("span");e.className="aulasaovivo__badge",e.textContent=m.config.strings.enrolledbadge,l.appendChild(e)}if("enrolled"===t){const e=document.createElement("span");e.className="aulasaovivo__badge",e.textContent=m.config.strings.confirmedbadge,l.appendChild(e)}const d=document.createElement("button");d.type="button",d.className="aulasaovivo__button",l.appendChild(d),i.appendChild(l),a.appendChild(n),a.appendChild(i);const u={session:e,panel:t,element:a,button:d,countdown:s,agendaItem:null,state:"upcoming"};return d.addEventListener("click",()=>B(u)),u},M=(e,t,a,n={})=>{if(!a)return;const o=document.createElement("span");o.className="aulasaovivo__card-meta-item";const s=n.showLabel??!0;o.textContent=s&&t?`${t}: ${a}`:a,e.appendChild(o)},L=e=>{const t=document.createElement("div");t.className="aulasaovivo__agenda-item";const a=document.createElement("div");a.className="aulasaovivo__agenda-time",a.textContent=D(e);const n=document.createElement("div");n.className="aulasaovivo__agenda-name",n.textContent=e.name;const o=document.createElement("div");return o.className="aulasaovivo__agenda-status",t.appendChild(a),t.appendChild(n),t.appendChild(o),t},T=e=>{$(e),d.set(e.element,e)},$=e=>{const t=Date.now(),a=1e3*(e.session.starttime||0),n=1e3*(e.session.duration||0),o=a&&n?a+n:a+36e5,s=e.session.endtime?1e3*e.session.endtime:o;let i=m.config.strings.agendaunconfirmed,r="past";if(!a||t<a){r="upcoming",i=m.config.strings.agendaunconfirmed;const n=(a||t)-t;e.countdown.innerHTML=`<span class="aulasaovivo__card-countdown-label">${m.config.strings.countdownlabel}</span>${k(n)}`}else if(t>=a&&t<=s){r="live",i=m.config.strings.agendalive;const a=Math.max(0,s-t);e.countdown.innerHTML=`<span class="aulasaovivo__card-countdown-label">${m.config.strings.countdownlive}</span>${k(a)}`}else r="past",i=m.config.strings.agendapast,e.countdown.innerHTML=`<span class="aulasaovivo__card-countdown-label">${m.config.strings.countdownfinished}</span>${q(a)}`;if(e.state=r,e.element.dataset.state=r,e.agendaItem){e.agendaItem.dataset.state=r;const t=e.agendaItem.querySelector(".aulasaovivo__agenda-status");t&&(t.textContent=i)}I(e)},k=e=>{let t=Math.max(0,Math.floor(e/1e3));const a=Math.floor(t/86400);t-=86400*a;const n=Math.floor(t/3600);t-=3600*n;const o=Math.floor(t/60),s=[];return a&&s.push(`${a}d`),(n||a)&&s.push(`${n.toString().padStart(2,"0")}h`),s.push(`${o.toString().padStart(2,"0")}m`),s.join(" ")},q=e=>{if(!e)return"";const t=new Date(e);return m.formatters.shortDate.format(t)},A=e=>{if(!e.starttime)return"";const t=new Date(1e3*e.starttime);return`${m.formatters.date.format(t)} • ${m.formatters.time.format(t)}`},D=e=>{if(!e.starttime)return"";const t=new Date(1e3*e.starttime);return`${m.formatters.shortDate.format(t)} • ${m.formatters.time.format(t)}`},I=e=>{if(!e.button)return;const t=e.session,a=e.state,n=m.config.strings;if("catalog"!==e.panel)if("live"===a){const a=Boolean(t.launchurl);j(e,n.accesssession,a?"success":"secondary",!a)}else j(e,"upcoming"===a?n.accesssession:n.seemore,"secondary",!0);else{if(!t.isenrolled)return void("past"===a?j(e,n.sessionclosed,"secondary",!0):j(e,n.enrolsession,"primary",!1));if("live"===a){const a=Boolean(t.launchurl);j(e,n.accesssession,a?"success":"secondary",!a)}else j(e,"past"===a?n.sessionclosed:n.enrolledbadge,"secondary",!0)}},j=(e,t,a,n)=>{e.button.textContent=t,e.button.dataset.variant=a,e.button.disabled=n,e.button.setAttribute("aria-disabled",n?"true":"false")},B=e=>{if(e.button&&!e.button.disabled)if("catalog"===e.panel){if(!e.session.isenrolled&&"past"!==e.state)return void F(e);e.session.isenrolled&&e.session.launchurl&&"live"===e.state&&H(e.session.launchurl)}else"enrolled"===e.panel&&e.session.launchurl&&"live"===e.state&&H(e.session.launchurl)},H=e=>{window.open(e,"_blank","noopener")},F=a=>{const[n]=e.call([{methodname:m.config.services.enrol,args:{sessionid:a.session.id}}]);j(a,m.config.strings.processing,"secondary",!0),n.then(e=>{if(e.usingfallback&&(m.fallback=!0),e.status)return z(m.config.strings.enrolsuccess),a.session.isenrolled=!0,h();const t=e.message||m.config.strings.enrolfailure;z(t),a.session.isenrolled=!1,h("catalog")}).catch(e=>{t.exception(e),z(m.config.strings.enrolfailure),h("catalog")})},W=()=>{const e=m.root.querySelector(c);e&&(m.fallback?e.hidden=!1:e.hidden=!0)},z=e=>{const t=m.root.querySelector(r);t&&(t.textContent=e||m.config.strings.toastdefault,t.dataset.visible="true",clearTimeout(u),u=window.setTimeout(()=>{t.dataset.visible="false"},4e3))};return{init:e=>{if(!e)return;const a=document.getElementById(e);if(!a)return;const n=(e=>{const a=e.dataset.config;if(!a)return null;try{return JSON.parse(a)}catch(e){return t.exception(e),null}})(a);n&&(m={root:a,config:n,fallback:!1,formatters:f(n)},v(),p(),h())}}});